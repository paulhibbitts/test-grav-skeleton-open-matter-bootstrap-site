{% if page.header.show_sidebar is defined %}
  {% set show_sidebar = page.header.show_sidebar %}
{% else %}
  {% set show_sidebar = true %}
{% endif %}

{% embed 'partials/base.html.twig' %}

    {% set collection = page.collection() %}
    {% set base_url = page.url %}
    {% set feed_url = base_url %}

    {% if base_url == '/' %}
        {% set base_url = '' %}
    {% endif %}

    {% if base_url == base_url_relative %}
        {% set feed_url = base_url~'/'~page.slug %}
    {% endif  %}

    {% block content %}
        {# check content display flag - hibbittsdesign.org #}
        {% if not (grav.uri.param('chromeless')) and not(theme_var('chromeless.enabled')) %}
          {# remove default Bootstrap hero - hibbittsdesign.org #}
          {% set blog_image = page.media.images | first %}
          {% if blog_image %}
            <div class="header" style="background-image: url({{ blog_image.url }});">
          {% else %}
            <div class="header">
          {% endif %}
              <div class="container">
                  {{ page.content }}
              </div>
          </div>
        {% endif %}
        <div class="main-content">
            <div class="container">
                <div class="row">
                  {# check content display flag - hibbittsdesign.org #}
                  {% if not (grav.uri.param('chromeless')) and (show_sidebar) %}
                    <div class="col-md-8 blog-main">
                  {% else %}
                    <div class="col-md-12 blog-main">
                  {% endif %}

                        {% if config.plugins.breadcrumbs.enabled %}
                            {% include 'partials/breadcrumbs.html.twig' %}
                        {% endif %}

                        {# Added reminders and preparations blocks and content check - hibbittsdesign.org #}
                        {% if page.collection('modular_content') is not empty %}
                          {% for module in page.collection('modular_content') %}
                            {% if (module.content|striptags)|trim %}
                              <p>{{ module.content }}</p>
                            {% endif %}
                          {% endfor %}
                          <hr>
                        {% endif %}

                        {# Added display of featured post - hibbittsdesign.org #}
                        {% for post in taxonomy.findTaxonomy({'tag': "featured"}) %}
                          {% if (post.header.hide_from_post_list != true) and (post.parent.slug == page.slug) %}
                            {% include 'partials/blog_item.html.twig' with {'page':post, 'truncate':true} %}
                          {% endif %}
                        {% endfor %}

                        {% for child in collection %}
                          {# Added check for hiding post in list - hibbittsdesign.org #}
                          {% if child.header.hide_from_post_list != true %}
                            {# Added check for not repeating feature post - hibbittsdesign.org #}
                            {% if "featured" not in child.taxonomy['tag'] %}
                              {% include 'partials/blog_item.html.twig' with {'page':child, 'truncate':true} %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}

                    </div>

                    {# Check content display flag - hibbittsdesign.org #}
                    {% if not (grav.uri.param('chromeless')) and (show_sidebar) %}
                      <div class="col-md-4 blog-sidebar">
                          {% include 'partials/sidebar.html.twig' with {'blog':page} %}
                      </div>
                    {% endif %}

                </div>
            </div>
        </div>
    {% endblock %}

    {% block pagination %}
        {% if config.plugins.pagination.enabled and collection.params.pagination %}
        <div class="container pagination-container">
            <div class="row">
                {# check content display flag - hibbittsdesign.org #}
                {% if (not (grav.uri.param('chromeless')) and not (config.site.hidesidebaronblogpages.enabled)) and page.header.show_sidebar %}
                  <div class="col-md-8">
                {% else %}
                  <div class="col-md-12">
                {% endif %}
                    {% include 'partials/pagination.html.twig' with {'base_url':page.url, 'pagination':collection.params.pagination} %}
                </div>
            </div>
        </div>
        {% endif %}
    {% endblock %}

{% endembed %}
